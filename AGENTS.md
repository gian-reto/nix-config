# Agent Guidance

This document provides guidance for AI agents on how to interact with this NixOS configuration repository, which contains my personal NixOS flake. This includes host and user configurations, as well as shared configurations for various features.

## Index

The following documentation files can be consulted for more detailed information on how to work with this repository or accomplish specific tasks:

- [Feature Overview](./docs/feature_overview.md): Provides an overview of the concept of "features" in this repository, and how they are structured and used.
- [Feature Addition Recipe](./docs/feature_add_recipe.md): A step-by-step guide for adding a new feature to the configuration.
- [Module Overview](./docs/module_overview.md): Provides an overview of the concept of "modules" in this repository, and how they are structured and used.
- [Module Addition Recipe](./docs/module_add_recipe.md): A step-by-step guide for adding a new module to the configuration.

Always consult these documents before making changes to the configuration or adding new features. They provide essential context and instructions for working with the repository effectively.

## Repository Structure

This flake uses [combined-manager](https://github.com/FlafyDev/combined-manager), which to colocate `home-manager` and NixOS configurations that belong to the same feature in the same file.

Nix code for a feature is added to a `.nix` file in the `modules/features` directory. Nix code for an entire use-case is added to a `.nix` file in the `modules` directory; For example, all features that are relevant for a graphical desktop environment are enabled in `modules/gui.nix`. Host configurations in the `hosts` directory or user configurations in the `users` directory then enable the modules that are relevant for that host or user, e.g. `hosts/atlas/default.nix` enables the `gui` module, because `atlas` is a desktop machine.

This makes it easy to keep all the Nix code for an individual feature in one place, and enable it for an entire group of hosts or users by adding it to a module, or enable it for a single host or user by enabling it directly in their configuration.

File structure:

```md
- docs/ (Detailed documentation and recipes for working with this repository)
  - <name_recipe>.md
  - <name_overview>.md
  - ...
- files/ (Files imported by the configuration, e.g. public PGP key, wallpaper, etc.)
  - ...
- hosts/ (Configurations for individual hosts)
  - <hostname>/ (Configuration for a specific host)
    - default.nix (Host-specific configuration)
    - disk-configuration.nix (`disko` configuration for the host)
    - hardware-configuration.nix (Hardware configuration for the host)
  - common.nix (Common configuration for all hosts)
  - nix.nix (Configuration for the `nix` package manager itself)
- modules/ (Modules that can be enabled for hosts or users)
  - features/ (Self-contained configurations that can be enabled or disabled independently)
    - <feature_name>.nix (Configuration for a specific feature)
  - <module_name>.nix (Configuration for a specific module)
  - common.nix (Features that are enabled for all hosts)
  - default.nix (In this file, all features from `modules/features` are imported to make them available to enable in other parts of the configuration)
- pkgs/ (Custom packages / overlays that are not available in the official Nixpkgs repository)
  - overlays/
    - <overlay_name>/
      - default.nix (Custom overlay or derivation)
    - default.nix (Imports all overlays in `pkgs/overlays`)
  - default.nix (Adds the overlays to the Nixpkgs package set)
- templates/ (Reusable templates, e.g. for bootstrapping a new feature, etc.)
  - feature.nix (Template for adding a new feature in `modules/features`)
  - ...
- users/ (Configurations for individual users)
  - <username>/ (Configuration for a specific user)
    - default.nix (User-specific configuration)
- flake.lock (Lock file for the flake, autogenerated, so do not edit)
- flake.nix (Main entry point for my flake, which also contains inputs)
- README.md (General information about the repository)
```

Note: The directory `modules/features/ags/` is different from the other features, because it is a directory which contains my entire `ags` shell configuration as a TypeScript project, which is then also used in my NixOS config. More info about `ags` can be found in the project's documentation: [GitHub: Aylur/ags](https://github.com/Aylur/ags).

## Style

- **Naming**:
  - Prefer descriptive naming for files, directories, variables, etc., but try to use a single word if possible.
  - Avoid abbreviations or letters for names, unless it's a built-in Nix language term (e.g., `pkgs`, `lib`, etc.).
  - Sort imports or other lists alphabetically, unless the order is significant.
  - Use kebab-case for file/directory names, camelCase for Nix attributes.
- **Language**:
  - Primarily `nix` (the language), except for the TypeScript subproject in `modules/features/ags/config`.
  - TypeScript:
    - Even though `ags` uses `.tsx` for components, it's not React. It uses Gnim, which is brings JSX and reactivity to GNOME GJS. Consult the `ags` documentation in the [AGS Wiki](https://aylur.github.io/ags).
    - Prefer strong typing and avoid `any`.
  - Shell:
    - Only use when necessary.
    - Use `#!/usr/bin/env` shebangs, quote variables properly.
    - When using shell code in a Nix string (`''`), escape shell interpolations properly, i.e., use `''${var}` (double quotes only at the start of the variable) instead of the usual backslash (`\`) escaping.
  - ...avoid using other languages unless absolutely necessary.
- **Imports**: Group imports at top, use relative paths for local modules.
- **Comments**:
  - Only use comments for non-obvious pieces of code (e.g., workarounds, complex logic, notable decisions or hints).
  - Word comments in a generic way.
  - Always end a comment with a period.
- **Formatting**: Always format using `alejandra`, see section "Commands" below.
- **Linting**: Use `nil` for linting, see section "Commands" below.

## Commands

- **Formatting**: Use `alejandra format <path_to_file>.nix` to format a specific Nix file.
- **Linting**: Use `nil diagnostics <path_to_file>.nix` to check for syntax errors in a specific Nix file.
- **Switch to new configuration**: Use the command `oss` without any other arguments or flags (it's an alias for `nh os switch` and `nixos-rebuild switch`) to build and switch to the new configuration. It determines the current host / flake automatically.

## Workflow

- Always ask for confirmation before executing a command that applies changes to the system.
- Always consult the respective recipe in the `docs/` directory, if available.
- Always ask for clarification if something is not clear.
- Always ask before building or switching to a new configuration.
